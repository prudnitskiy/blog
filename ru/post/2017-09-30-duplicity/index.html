<!doctype html><html lang=ru-ru data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Duplicity – экстремально простой способ резервного копирования - Инфраструктурный блог</title>
<meta name=description content="краткое руководство по настройке duplicity - очень простой системы резеревного копирования"><link rel=icon type=image/x-icon href=https://prudnitskiy.pro/favicon.ico><link rel=apple-touch-icon-precomposed href=https://prudnitskiy.pro/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><link rel=stylesheet href=/css/style.min.44f8240afd8df81b52565c4119ac5ae247776c77fc6d7ccf6e101a6c98abfa7a.css integrity="sha256-RPgkCv2N+BtSVlxBGaxa4kd3bHf8bXzPbhAabJir+no="><link rel=stylesheet href=/css/style.min.c4c04b3ef88e3d619ad4c7ee5e03048422bc55c4fefdc1f07657c1133670aa22.css integrity="sha256-xMBLPviOPWGa1MfuXgMEhCK8VcT+/cHwdlfBEzZwqiI="><link rel=stylesheet href=/css/style.min.21c5d8fe0a79d623b0adc1ce4bd4f6dd2c05cd939c9aaaa966ba7186b1464f4d.css integrity="sha256-IcXY/gp51iOwrcHOS9T23SwFzZOcmqqpZrpxhrFGT00="><script src=/js/script.min.08f04d96386c73c9bf4d160333f8f448c05a6e01c06770542ee0e013954ce930.js type=text/javascript integrity="sha256-CPBNljhsc8m/TRYDM/j0SMBabgHAZ3BULuDgE5VM6TA="></script><link rel=canonical href=https://prudnitskiy.pro/ru/post/2017-09-30-duplicity/ itemprop=url></head><body><a class=skip-main href=#main>Перейти к основному контенту</a><div class=container><header class=common-header><div class=header-top><div class=header-top-left><h1 class="site-title noselect"><a href=/ru>Инфраструктурный блог</a></h1><div class=theme-switcher><span class=inline-svg><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-sun-high"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14.828 14.828A4 4 0 109.172 9.172a4 4 0 005.656 5.656z"/><path d="M6.343 17.657l-1.414 1.414"/><path d="M6.343 6.343 4.929 4.929"/><path d="M17.657 6.343l1.414-1.414"/><path d="M17.657 17.657l1.414 1.414"/><path d="M4 12H2"/><path d="M12 4V2"/><path d="M20 12h2"/><path d="M12 20v2"/></svg></span></div><script>const STORAGE_KEY="user-color-scheme",defaultTheme="auto";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");function switchTheme(){currentTheme=currentTheme==="dark"?"light":"dark",localStorage&&localStorage.setItem(STORAGE_KEY,currentTheme),document.documentElement.setAttribute("data-theme",currentTheme),changeGiscusTheme(currentTheme),document.body.dispatchEvent(new CustomEvent(currentTheme+"-theme-set"))}const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeGiscusTheme(currentTheme),document.body.dispatchEvent(new CustomEvent(currentTheme+"-theme-set"))};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme==="auto"?(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)):document.documentElement.setAttribute("data-theme",currentTheme),switchButton&&switchButton.addEventListener("click",switchTheme,!1),showContent()});function detectCurrentScheme(){return localStorage!==null&&localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}function changeGiscusTheme(e){function t(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}t({setConfig:{theme:e}})}</script><ul class="social-icons noselect"><li><a href=https://github.com/prudnitskiy title=Github rel=me><span class=inline-svg><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-github"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></span></a></li><li><a href=https://www.linkedin.com/in/prudnitskiy title=Linkedin rel=me><span class=inline-svg><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"/><path d="M8 11v5"/><path d="M8 8v.01"/><path d="M12 16v-5"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></span></a></li><li><a href=/ru/index.xml title=RSS rel=me><span class=inline-svg><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-rss"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></span></a></li></ul></div><div class=header-top-right></div></div><nav class=noselect><a href=https://prudnitskiy.pro/ru/about/ title=About>About</a>
<a href=https://prudnitskiy.pro/ru/ title=Blog>Blog</a></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">Duplicity – экстремально простой способ резервного копирования</h1></header><div class="post-info noselect"><div class="post-date dt-published"><time datetime=2017-09-30>2017-09-30</time></div><a class="post-hidden-url u-url" href=/ru/post/2017-09-30-duplicity/>/ru/post/2017-09-30-duplicity/</a>
<a href=https://prudnitskiy.pro/ class="p-name p-author post-hidden-author h-card" rel=me>map[name:Paul Rudnitskiy]</a><div class=post-taxonomies><ul class=post-tags><li><a href=/ru/tags/backup/>#Backup</a></li></ul></div></div></div><details class="toc noselect"><summary>Table of Contents</summary><div class=inner><nav id=TableOfContents><ul><li><a href=#установка-и-настройка>Установка и настройка</a></li><li><a href=#резервное-копирование>Резервное копирование</a></li><li><a href=#проверка-и-восстановление>Проверка и восстановление</a></li></ul></nav></div></details><script>var toc=document.querySelector(".toc");toc&&toc.addEventListener("click",function(){event.target.tagName!=="A"&&(event.preventDefault(),this.open?(this.open=!1,this.classList.remove("expanded")):(this.open=!0,this.classList.add("expanded")))})</script><div class="content e-content"><p>Как гласит старинная шутка, системные администраторы делятся на две группы: те, которые не делают бэкапы, и те, которые уже делают бэкапы. Систем резеревного копирования существует великое множество, от простейшего самописного скрипта до огромных монстров ценой в &ldquo;боинг&rdquo;. Все системы нужны для разных целей и выполняют разные задачи.</p><p>Основная, самая известная и популярная система в мире unix и linux – это, безусловно, bacula. Умеет bacula очень много - сложные расписания и политики хранения, шифрование данных и клиент-серверного трафика, управление операциями &ldquo;на ходу&rdquo;, десятки способов упаковки и проверки данных. Полный список возможностей bacula занимает несколько страниц мелкого текста. Основной минус бакулы находится ровно там, где находится ее плюс. Внедрение и настройка бакулы - это приключение, как минимум, на неделю. Документации очень много (но ее все равно не хватает). Бакула состоит из 4 самостоятельных компонентов (director, storage, filedaemon, console), каждый из которых настраивается и живет отдельно. Все эти компоненты имеют сложные взаимоотношения и должны быть доступны друг другу напрямую, что тоже жизнь не облегчает. Элементарный конфиг bacula легко может весить десятки килобайт (и bacula очень трепетно относится к опечаткам в конфиге - он в лучшем случае вообще не прочитается, а в худшем сервис упадет). В случае, если нужно делать резервные копии с одного-двух серверов - bacula - явный оверкилл. Вместо сложного комбайна нужен простой и понятный молоток. И такой молоток есть - он называется duplicity.</p><p>Duplicity - это очень просто. Это одна-единственная команда, которая запускается на том сервере, откуда будут копироваться данные. Все, что она может:</p><ul><li>сделать резервную копию. Резервная копия пакуется в блоки (назывются тома), и, по желанию, шифруются. Резервная копия может быть или полной, или инкрементальной. Уровень определяется возрастом копии - если последняя полная копия старше определенного возраста - будет сделана полная, если нет - инкрементальная копия.</li><li>отправить резервную копию на удаленный сервер. Удаленный сервер может быть rsync, ftp, scp, s3 (вариантов много). Можно хранить прямо в файловой системе. Устройства хранения (ленточные библиотеки, дисковые массивы) – не поддерживатюся.</li><li>найти расходждения между каталогом и определенной версией бекапа. Полезно, чтобы понять, что изменилось с момента бэкапа.</li><li>показать список файлов в бэкапе.</li><li>восстановить файлы из бэкапа (или весь бэкап целиком).</li><li>почистить удаленный сервер от старых бэкапов.</li></ul><p>На этом функционал duplicity заканчивается. Ничего сложного, головоломного, неочевидного. Система, понятная, как кирпич.</p><h2 id=установка-и-настройка><div><a href=#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%b8-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0>#
</a>Установка и настройка</div></h2><p>Duplicty входит в пакет с одноименным названием, и устанавливается традиционно для вашей операционной системы:</p><pre><code>#debian, ubuntu
apt-get install duplicity

#centos, redhat, fedora
yum install duplicity
</code></pre><p>Теперь нужно решить, куда будут отправляться пакеты. Duplicty не может работать с удаленным сервером самостоятельно - в зависимости от типа удаленного сервера ему потребуется тот или иной пакет. Сам duplicity только &ldquo;дирижирует процессом&rdquo;. Самые ходовые типы серверов и пакеты:</p><ul><li>ftp, ftps (ftp over TLS): ncftp</li><li>rsync: rsync</li><li>s3 (aws S3, openstack swift, ceph object gateway, minio): boto</li></ul><p>Если планируется шифровать и/или подписывать бэкап - нужно сгенерировать gpg-ключ. Шифровать бэкап рекомендуется, если нет доверия серверу хранения. Правило хорошего тона гласят, что доверия нет никогда и никому. Помните о том, что бэкап, по сути – отложеное по времени нарушение безопасности. Ключ генерируется вполне традиционым способом:</p><pre><code>gpg --gen-key
</code></pre><p>Параметры ключа (размер, алгоритм) менять не обязательно, они вполне разумны. После окончания генерации GPG вернет идентификатор ключа. Его так же можно посмотреть вот так:</p><pre><code>gpg --list-keys

/root/.gnupg/pubring.gpg
------------------------
pub   2048R/F6822D5F 2017-01-28
uid                  Paul I Rudnitskiy (bck server) &lt;admin@prudnitskiy.pro&gt;
sub   2048R/292EB891 2017-01-28
</code></pre><p>ID нам чуть дальше пригодится, рекомендую его запомнить.</p><p>Так же очень рекомендуется сделать разеревную копию GPG-ключа. Если бэкап зашифрован - потеря ключа автоматически означает потерю возможности восстановить данные из бэкапа. Выгрузим ключ, чтобы сохранить его в надежное место:</p><pre><code>gpg --export-secret-keys -a F6822D5F  &gt; backup.asc
</code></pre><h2 id=резервное-копирование><div><a href=#%d1%80%d0%b5%d0%b7%d0%b5%d1%80%d0%b2%d0%bd%d0%be%d0%b5-%d0%ba%d0%be%d0%bf%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5>#
</a>Резервное копирование</div></h2><p>Общий принцип - <code>duplicity [args] {source} {destination}</code>. Аргументов множество, ниже я приведу пример и распишу, что означает каждый. Проще всего сделать shell-скрипт с командой и типовыми аргументами, чтобы не вспоминать их каждый раз</p><pre><code>duplicity --verbosity notice \
    --encrypt-key &quot;F6822D5F&quot; \
    --full-if-older-than 14D \
    --num-retries 3 \
    --asynchronous-upload \
    --volsize 100 \
    --archive-dir /var/tmp/.duplicity \
    --log-file /var/log/duplicity.log \
    --exclude &quot;/var/lib/postgresql/9.5/main/archive&quot; \
    &quot;/var/lib/postgresql/9.5/main/&quot; \
    &quot;ftp://bckuser:iem4ob9bah1FohNi@verysecret.prudnitskiy.pro/pgsql&quot;
</code></pre><p>На что обратить внимание:</p><ul><li><em>verbosity</em> - уровень &ldquo;говорливости&rdquo; при работе. Рекомендуется info при отладке (показывает файлы и текущие операции) и notice в production (кратко сообщает о текущем этапе работы)</li><li><em>encrypt-key</em> - ID ключа для шифрования. Важен, если ключей несколько. Если шифровать не нужно - используйте аргумент <code>--no-encryption</code>. При шифровании gpg спросит пароль ключа шифрования. Побеждается или настройкой gpg-agent или созданием переменной <code>PASSPHRASE</code> с паролем.</li><li><em>full-if-older-than</em> - через срок после создания полной копии нужно сделать не инкрементальную, а снова полную копию. В данном примере - 14 дней.</li><li><em>volsize</em> - размер одного тома в мегабайтах. Каждый том пакуется и загружается на сервер отдельно, это отдельный файл.</li><li><em>archive-dir</em> - папка, где duplicity локально хранит метаданные (информацию о томах и их содержимом). Копия метаданных лежит на сервере. Если по какой-то причине метаданные пропадут - duplicity придется скачать копию метаданных с сервера перед началом бэкапа. Размер папки метаданных пропорционально зависит от количества файлов и количества бэкапов, так что стоит выделить ей побольше места.</li><li><em>exclude</em> - позволяет исключить папку из бэкапа. аргументов exclude может быть несколько.</li><li><em>destination</em> - последний аргумент, куда копируем данные. Задается в виде классического url. URL для копии в локальную файловую систему имеет вид <code>file:///path/to/folder</code></li></ul><p>Проверка состояния бэкапов на удаленном сервере:</p><pre><code>duplicity collection-status &quot;ftp://bckuser:iem4ob9bah1FohNi@verysecret.prudnitskiy.pro/pgsql&quot; \
    --archive-dir /var/tmp/.duplicity
</code></pre><p>Пример ответа:</p><pre><code>NcFTP version is 3.2.5
Local and Remote metadata are synchronized, no sync needed.
Last full backup date: Fri Sep 15 04:10:03 2017
Collection Status
-----------------
Connecting with backend: FTPBackend
Archive dir: /var/tmp/.duplicity/c9edc22d8a99b972fdf4bd3cec26e19f

Found 1 secondary backup chain.
Secondary chain 1 of 1:
-------------------------
Chain start time: Thu Aug 31 04:10:03 2017
Chain end time: Thu Sep 14 04:10:02 2017
Number of contained backup sets: 15
Total number of contained volumes: 252
 Type of backup set:                            Time:      Num volumes:
                Full         Thu Aug 31 04:10:03 2017               137
         Incremental         Fri Sep  1 04:10:02 2017                 6
----------------------------CUT----------------------------------------
-------------------------


Found primary backup chain with matching signature chain:
-------------------------
Chain start time: Fri Sep 15 04:10:03 2017
Chain end time: Fri Sep 29 04:10:03 2017
Number of contained backup sets: 15
Total number of contained volumes: 245
 Type of backup set:                            Time:      Num volumes:
                Full         Fri Sep 15 04:10:03 2017               142
         Incremental         Sat Sep 16 04:10:02 2017                 8
----------------------------CUT----------------------------------------
         Incremental         Fri Sep 29 04:10:03 2017                 7
-------------------------
No orphaned or incomplete backup sets found.
</code></pre><p>Duplicity не позволяет помечать бэкап как устаревший автоматически (retention в терминологии &ldquo;взрослых&rdquo; систем). Чистить ненужные бэкапы придется в ручном режиме:</p><pre><code>duplicity --verbosity notice \
--archive-dir /var/tmp/.duplicity \
--force \
remove-all-but-n-full 4 \
&quot;ftp://bckuser:iem4ob9bah1FohNi@verysecret.prudnitskiy.pro/pgsql&quot;
</code></pre><p>Эта команда удалит все бэкапы старше 4 последних полных бэкапов. В примере выше мы делали полный бекап каждые 2 недели, то есть duplicity удалит бэкапы старше 2 месяцев (8 недель). Если убрать ключ <code>--force</code> – duplicity найдет старые бэкапы, но не будет их удалять - только выведет на консоль. Забывать о чистке не рекомендуется - место на сервере для резервных копий может неожиданно кончиться и оставить вас без свежих бэкапов. Выясняется это весьма болезненно.</p><h2 id=проверка-и-восстановление><div><a href=#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0-%d0%b8-%d0%b2%d0%be%d1%81%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b5>#
</a>Проверка и восстановление</div></h2><p>Посмотрим файлы, которые у нас есть в бэкапе:</p><pre><code>duplicity --archive-dir /var/tmp/.duplicity list-current-files \
    &quot;ftp://bckuser:iem4ob9bah1FohNi@verysecret.prudnitskiy.pro/pgsql&quot;
</code></pre><p>Пример ответа:</p><pre><code>NcFTP version is 3.2.5
Local and Remote metadata are synchronized, no sync needed.
Last full backup date: Sat Sep 29 04:10:03 2017
Mon Oct  2 04:10:02 2017 .
Mon Aug 29 21:07:04 2016 PG_VERSION
Mon Oct  2 04:10:02 2017 backup_label
-----------------------CUT---------------------------------
</code></pre><p>Команда выше покажет состояние на момент <em>последнего</em> бэкапа. Чтобы получить информацию из более старых бэкапов, нужно использовать ключ <code>-t</code>. К примеру, <code>-t6D</code> вернет информацию о бэкапе, сделаном 6 дней назад.</p><p>Восстановление данных выглядит ровно так же, как бэкап, нужно просто поменять местами source (откуда брать данные) и destination:</p><pre><code>duplicity --verbosity notice \
    --encrypt-key &quot;F6822D5F&quot; \
    --archive-dir /var/tmp/.duplicity \
    --log-file /var/log/duplicity.log \
    &quot;ftp://bckuser:iem4ob9bah1FohNi@verysecret.prudnitskiy.pro/pgsql&quot; \
    &quot;/var/lib/postgresql/9.5/main/&quot;
</code></pre><p>На что обратить внимание:</p><ul><li>Если нужно восстановить бэкап на определенную дату - выручает ключ <code>-t</code></li><li>Для восстановления определенного файла нужно использовать ключ <code>--file-to-restore</code>. Таких ключей может быть несколько.</li><li>Восстановление возможно только в совершенно пустую папку</li><li>Для восстановления duplicity вытащит с сервера резервных копий <em>весь</em> полный бэкап и все инкрементальные бэкапы с момента полного до точки восстановления. Места уйдет много.</li></ul></div></article><h3 class="read-next-title noselect">Читать далее</h3><ul class="read-next-posts noselect"><li><a href=/ru/post/2016-04-21-xtrabackup/>Резервное копироварие mysql с помощью xtrabackup</a></li></ul><div class="pagination post-pagination"><div class="left pagination-item"><a href=/ru/post/2018-01-05-pgsql-replica/>Потоковая репликация в PostgreSQL – короткое введение</a></div><div class="right pagination-item"><a href=/ru/post/2017-09-15-jekyll/>Как (и зачем) перевести блог на статический сайт</a></div></div></main><footer class="common-footer noselect"><ul class=language-select><li>Русский</li><li><a href=/en/>English</a></li></ul><div class=common-footer-bottom><div style=display:flex;align-items:center;gap:8px>© Paul Rudnitskiy, 2025</div><div style=display:flex;align-items:center></div><div>Движок <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, тема <a target=_blank rel="noopener noreferrer" href=https://github.com/Junyi-99/hugo-theme-anubis2>Anubis2</a>.<br></div></div><p class="h-card vcard"><a href=https://prudnitskiy.pro/ class="p-name u-url url fn" rel=me>map[name:Paul Rudnitskiy]</a></p></footer></div></body></html>